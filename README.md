# Self-Hosted GitHub Actions Runner

This repository contains everything needed to set up a self-hosted GitHub Actions runner using Docker.

## Prerequisites

- Docker installed on the host machine
- Docker Compose installed
- GitHub Personal Access Token with `repo` and `workflow` scopes
- GitHub repository or organization to register the runner with

## Quick Start

### 1. Configure Environment Variables

Copy the example environment file and edit it:

```bash
cp .env.example .env
```

Edit `.env` and set the required variables:
- `GITHUB_OWNER`: Your GitHub username or organization name
- `GITHUB_REPOSITORY`: Repository name (leave empty for organization-level runner)
- `RUNNER_NAME`: Unique name for this runner
- `ACCESS_TOKEN`: GitHub Personal Access Token

### 2. Create a GitHub Personal Access Token

1. Go to GitHub Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Click "Generate new token (classic)"
3. Select scopes: `repo` (for private repos) or `public_repo` (for public repos), `workflow`
4. Generate and copy the token

### 3. Get Runner Registration Token

Use the setup script to generate a registration token:

```bash
./setup.sh
```

This will automatically update the `.env` file with the registration token.

### 4. Start the Runner

```bash
docker compose up -d
```

### 5. Verify Runner is Running

```bash
docker compose logs -f
```

Check your GitHub repository Settings → Actions → Runners to see if the runner is online.

## Configuration Options

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `GITHUB_OWNER` | Yes | GitHub username or organization |
| `GITHUB_REPOSITORY` | No | Repository name (empty for org-level) |
| `RUNNER_NAME` | Yes | Unique name for the runner |
| `RUNNER_LABELS` | No | Comma-separated labels (default: `self-hosted`) |
| `ACCESS_TOKEN` | Yes | GitHub Personal Access Token |
| `REGISTRATION_TOKEN` | Yes | Generated by setup script |
| `DOCKER_ENABLED` | No | Enable Docker in Docker (default: `true`) |

### Runner Labels

Labels help organize your runners. Default labels: `self-hosted`, `linux`, `x64`

Customize in `.env`:
```
RUNNER_LABELS=self-hosted,linux,x64,docker,large
```

## Management Commands

### View Logs
```bash
docker compose logs -f
```

### Stop Runner
```bash
docker compose down
```

### Restart Runner
```bash
docker compose restart
```

### Update Runner
```bash
docker compose pull
docker compose up -d
```

### Remove Runner Configuration
```bash
docker compose down -v
rm -rf _work
```

## Using the Runner

### Repository Level Runner

Add to your workflow:
```yaml
jobs:
  build:
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4
      # Your steps here
```

### Organization Level Runner

The runner will be available to all repositories in the organization.

## Troubleshooting

### Runner shows offline in GitHub

Check the logs:
```bash
docker compose logs runner
```

Common issues:
- Registration token expired (re-run `./setup.sh`)
- Network connectivity issues
- Firewall blocking GitHub URLs

### Docker-in-Docker issues

If you need Docker support, ensure:
- `DOCKER_ENABLED=true` in `.env`
- Volume mounts are correct in docker-compose.yml
- Runner has sufficient permissions

### Runner registration fails

1. Verify ACCESS_TOKEN is valid
2. Check GITHUB_OWNER and GITHUB_REPOSITORY
3. Ensure you have permissions to add runners
4. Check GitHub rate limits

## Security Best Practices

1. **Rotate tokens regularly**: Registration tokens expire, regenerate with `./setup.sh`
2. **Limit runner permissions**: Use least-privilege access tokens
3. **Monitor runner activity**: Check GitHub Actions logs
4. **Update regularly**: Keep runner image updated with `docker compose pull`
5. **Network isolation**: Consider running in isolated network
6. **Resource limits**: Set CPU and memory limits in docker-compose.yml

## Scaling

To run multiple runners, create multiple docker-compose files:

```bash
docker compose -f docker-compose.yml -f docker-compose.runner2.yml up -d
```

Or use the `scale` command (not recommended for production as all runners share same config):

```bash
docker compose up -d --scale runner=3
```

## Automated Deployment

Use the provided GitHub Actions workflow to deploy runners from another repository:

1. Fork/clone this setup repository
2. Configure secrets in GitHub Actions settings:
   - `SSH_HOST`: Server hostname/IP
   - `SSH_USER`: SSH username
   - `SSH_KEY`: Private SSH key
   - `ACCESS_TOKEN`: GitHub Personal Access Token
3. Run the "Deploy Runner" workflow

## Support

For issues:
- Check GitHub Actions runner documentation: https://docs.github.com/en/actions/hosting-your-own-runners
- Review Docker logs: `docker compose logs`
- Check GitHub status page: https://www.githubstatus.com/
